<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      href="https://www.trenitalia.com/etc.clientlibs/tcom/clientlibs/common/resources/immagini/favicon.ico"
    />
    <title>Verifica le tue Frecce</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.8.162/pdf.min.js"></script>
    <script>
      if (typeof pdfjsLib !== "undefined") {
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.8.162/pdf.worker.min.js";
      }
    </script>
    <script>
      tailwind.config = {
        important: true,
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#f0f6ff",
                100: "#e0ecff",
                200: "#c0daff",
                300: "#91bfff",
                400: "#609bff",
                500: "#3b76ff",
                600: "#1f4fff",
                700: "#1240ff",
                800: "#1435df",
                900: "#1832b5",
              },
              accent: {
                50: "#fff1f1",
                100: "#ffe1e1",
                200: "#ffc7c7",
                300: "#ffa0a0",
                400: "#ff6b6b",
                500: "#ff3b3b",
                600: "#ff1111",
                700: "#e70000",
                800: "#c00",
                900: "#a00",
              },
            },
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
  </head>
  <body
    class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 font-sans"
  >
    <div
      id="app"
      class="relative w-full min-h-screen flex flex-col items-center justify-center p-4 md:p-6"
      v-cloak
    >
      <div class="w-full max-w-4xl">
        <!-- Language Selector -->
        <div
          class="absolute top-4 right-4 md:top-6 md:right-6 bg-white/80 backdrop-blur-sm rounded-full px-4 py-2 shadow-sm"
        >
          <button
            v-for="lang in ['IT', 'EN']"
            :key="lang"
            @click="setLanguage(lang)"
            :class="[
              'px-3 py-1 rounded-full text-sm transition-all duration-200',
              language === lang 
                ? 'bg-primary-500 text-white font-medium shadow-sm' 
                : 'text-gray-600 hover:text-primary-600'
            ]"
          >
            {{ lang }}
          </button>
        </div>

        <!-- Main Content -->
        <div
          class="bg-white/80 backdrop-blur-sm rounded-2xl p-6 md:p-8 shadow-xl border border-white/50"
        >
          <div class="text-center mb-8">
            <h1
              class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-primary-600 to-accent-600 bg-clip-text text-transparent"
            >
              {{ t('title') }}
            </h1>
            <p class="mt-4 text-gray-600">
              {{ t('welcome') }}
              <a
                class="text-accent-600 hover:text-accent-700 font-medium underline-offset-4 hover:underline transition-colors"
                :href="t('trenitaliaUrl')"
                target="_blank"
              >
                {{ t('trenitaliaLink') }}
              </a>
            </p>
          </div>

          <!-- File Drop Zone -->
          <div
            id="drop"
            class="group relative overflow-hidden rounded-xl border-2 border-dashed transition-all duration-300 ease-in-out"
            :class="[
              dragging 
                ? 'border-primary-400 bg-primary-50' 
                : 'border-gray-300 hover:border-primary-300 hover:bg-gray-50'
            ]"
            @dragover.prevent="$event.dataTransfer.dropEffect = 'copy'"
            @drop.prevent="handleDrop"
            @dragenter="dragging = true"
            @dragleave="dragging = false"
            @click="openFileDialog"
          >
            <div
              class="p-8 md:p-12 flex flex-col items-center justify-center gap-4"
            >
              <div
                class="w-16 h-16 rounded-full bg-primary-100 flex items-center justify-center group-hover:scale-110 transition-transform duration-300"
              >
                <svg
                  class="w-8 h-8 text-primary-500"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path
                    d="M4 17v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 9l5-5m0 0l5 5m-5-5v12"
                  />
                </svg>
              </div>
              <div class="text-center">
                <p class="text-gray-600 mb-2">{{ t('dropZoneText') }}</p>
                <p class="text-sm text-gray-400">PDF files only</p>
              </div>
              <input
                ref="fileInput"
                type="file"
                multiple
                accept="application/pdf"
                class="hidden"
                @change="handleFileSelect"
              />
            </div>
          </div>

          <!-- File List -->
          <div class="mt-8" v-if="droppedFiles.length > 0">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-2">
                <div
                  class="w-8 h-8 rounded-full bg-primary-100 flex items-center justify-center"
                >
                  <svg
                    class="w-4 h-4 text-primary-500"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                    />
                  </svg>
                </div>
                <span class="font-medium text-gray-700">
                  {{ t('tickets') }}: {{ droppedFiles.length }}
                </span>
              </div>
              <button
                @click="removeFiles()"
                class="text-sm text-gray-500 hover:text-accent-600 transition-colors"
              >
                {{ t('clearAll') }}
              </button>
            </div>

            <div
              ref="filesContainer"
              class="space-y-4 max-h-[500px] overflow-y-auto pr-2 -mr-2"
            >
              <div
                v-for="fileObject in droppedFiles"
                :key="fileObject.file.name"
                class="bg-white rounded-xl shadow-sm border border-gray-100 transition-all duration-300 hover:shadow-md"
                :class="{ 'animate-pulse': fileObject.pending }"
              >
                <div class="p-4">
                  <!-- File Header -->
                  <div class="flex items-start justify-between">
                    <div class="flex-1">
                      <p class="text-sm text-gray-400 mb-1">
                        {{ fileObject.file.name }}
                      </p>
                      <div
                        v-if="fileObject.cp && fileObject.pnr"
                        class="flex flex-wrap gap-2"
                      >
                        <span
                          class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary-100 text-primary-800"
                        >
                          PNR: {{ fileObject.pnr }}
                        </span>
                        <span
                          class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary-100 text-primary-800"
                        >
                          CP: {{ fileObject.cp }}
                        </span>
                      </div>
                    </div>
                    <button
                      @click="removeFiles(fileObject)"
                      class="p-1 text-gray-400 hover:text-accent-500 transition-colors"
                    >
                      <svg
                        class="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M6 18L18 6M6 6l12 12"
                        />
                      </svg>
                    </button>
                  </div>

                  <!-- Verification Results -->
                  <div v-if="fileObject.verify?.result" class="mt-3">
                    <div class="flex items-center justify-between gap-4">
                      <div class="flex-1">
                        <div
                          v-if="fileObject.verify?.status !== 200"
                          class="px-3 py-2 rounded-lg bg-accent-50 border border-accent-100"
                        >
                          <p class="text-sm text-accent-700">
                            {{ fileObject.verify?.result?.type ||
                            t('failedRequest') }} - {{
                            t(fileObject.verify?.result?.message) ||
                            t('internalServerError') }}
                          </p>
                        </div>
                        <div
                          v-else
                          class="px-3 py-2 rounded-lg bg-green-50 border border-green-100"
                        >
                          <div class="flex items-center justify-between">
                            <p class="text-sm text-green-700">
                              {{ t('successRequest') }}
                            </p>
                            <a
                              v-if="fileObject.verify?.result?.solutions[0]?.resourceId"
                              :href="`https://www.lefrecce.it/Channels.Website.BFF.WEB/website/post/purchase/pdf?resourceId=${fileObject.verify.result.solutions[0].resourceId}`"
                              download="ticket.pdf"
                              class="text-xs text-primary-600 hover:text-primary-700 font-medium hover:underline"
                            >
                              Download PDF
                            </a>
                          </div>
                        </div>
                      </div>
                      <button
                        @click="toggleExpand(fileObject)"
                        class="flex items-center gap-1 text-xs text-primary-600 hover:text-primary-700 font-medium"
                      >
                        {{ fileObject.expanded ? t('hideRequest') :
                        t('showRequest') }}
                        <svg
                          class="w-4 h-4 transition-transform duration-200"
                          :class="{ 'rotate-180': fileObject.expanded }"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M19 9l-7 7-7-7"
                          />
                        </svg>
                      </button>
                    </div>

                    <!-- Expanded Details -->
                    <div
                      v-if="fileObject.expanded"
                      class="mt-3 p-3 rounded-lg bg-gray-900 overflow-x-auto transition-all duration-300 ease-in-out"
                    >
                      <pre class="text-xs text-gray-300 whitespace-pre-wrap">
{{ JSON.stringify(fileObject.verify.result, null, 2) }}</pre
                      >
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-6 flex flex-col items-center gap-4">
              <template v-if="globalProgress === 100">
                <template v-if="hasResults">
                  <div class="flex flex-col gap-3 w-full max-w-md">
                    <button
                      @click="generatePDF()"
                      :disabled="verifying"
                      class="w-full px-6 py-3 rounded-xl bg-primary-500 text-white font-medium shadow-sm hover:bg-primary-600 focus:ring-2 focus:ring-primary-200 disabled:opacity-50 transition-all duration-200"
                    >
                      <div class="flex items-center justify-center gap-2">
                        <svg
                          class="w-5 h-5"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                          />
                        </svg>
                        {{ t('exportReport') }}
                      </div>
                    </button>
                    <button
                      @click="verify()"
                      class="text-primary-600 hover:text-primary-700 font-medium hover:underline"
                    >
                      {{ t('newVerification') }}
                    </button>
                  </div>
                </template>
                <template v-else>
                  <button
                    @click="verify()"
                    :disabled="verifying"
                    class="px-6 py-3 rounded-xl bg-accent-500 text-white font-medium shadow-sm hover:bg-accent-600 focus:ring-2 focus:ring-accent-200 disabled:opacity-50 transition-all duration-200"
                  >
                    <div class="flex items-center justify-center gap-2">
                      <svg
                        class="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                        />
                      </svg>
                      {{ verifying ? `${t('verify')} (${globalProgress}%)` :
                      t('verify') }}
                    </div>
                  </button>
                </template>
              </template>
              <template v-else-if="verifying">
                <div class="flex flex-col items-center gap-3">
                  <div
                    class="w-full max-w-md bg-gray-100 rounded-full h-2 overflow-hidden"
                  >
                    <div
                      class="bg-primary-500 h-full transition-all duration-300 ease-out"
                      :style="{ width: `${globalProgress}%` }"
                    ></div>
                  </div>
                  <p class="text-sm text-gray-600">
                    {{ t('verify') }}: {{ globalProgress }}%
                  </p>
                </div>
              </template>
              <template v-else>
                <button
                  @click="verify()"
                  :disabled="verifying"
                  class="px-6 py-3 rounded-xl bg-accent-500 text-white font-medium shadow-sm hover:bg-accent-600 focus:ring-2 focus:ring-accent-200 disabled:opacity-50 transition-all duration-200"
                >
                  <div class="flex items-center justify-center gap-2">
                    <svg
                      class="w-5 h-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                      />
                    </svg>
                    {{ t('verify') }}
                  </div>
                </button>
              </template>
            </div>
          </div>
          <p v-else class="text-center text-gray-500 mt-6">
            {{ t('emptyList') }}
          </p>
        </div>
      </div>

      <!-- Toast Notifications -->
      <div class="fixed bottom-4 right-4 space-y-3 z-50" v-cloak>
        <transition-group name="toast">
          <div
            v-for="toast in toasts"
            :key="toast.id"
            @click="removeToast(toast.id)"
            class="flex items-center gap-3 p-4 rounded-xl shadow-lg border cursor-pointer transform transition-all duration-300 ease-out hover:scale-102"
            :class="[
                toast.type === 'error' ? 'bg-white border-accent-500' :
                toast.type === 'warning' ? 'bg-white border-yellow-500' :
                toast.type === 'info' ? 'bg-white border-primary-500' :
                'bg-white border-green-500'
              ]"
          >
            <div class="flex-shrink-0">
              <svg
                v-if="toast.type === 'error'"
                class="w-5 h-5 text-accent-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
              <svg
                v-if="toast.type === 'warning'"
                class="w-5 h-5 text-yellow-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 9v2m0 4h.01M12 5a7 7 0 110 14 7 7 0 010-14z"
                />
              </svg>
              <svg
                v-if="toast.type === 'info'"
                class="w-5 h-5 text-primary-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M12 18h.01M12 6h.01"
                />
              </svg>
              <svg
                v-if="toast.type === 'success'"
                class="w-5 h-5 text-green-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M5 13l4 4L19 7"
                />
              </svg>
            </div>
            <p class="text-sm text-gray-700">{{ toast.message }}</p>
          </div>
        </transition-group>
      </div>
    </div>

    <style>
      [v-cloak] {
        display: none;
      }

      .toast-enter-active,
      .toast-leave-active {
        transition: all 0.3s ease;
      }

      .toast-enter-from {
        opacity: 0;
        transform: translateX(30px);
      }

      .toast-leave-to {
        opacity: 0;
        transform: translateX(30px);
      }

      .pending {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
      }

      ::-webkit-scrollbar-thumb {
        background: #c5c5c5;
        border-radius: 3px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }
    </style>

    <script>
      // Create Vue app
      const { createApp, ref, reactive, computed, nextTick } = Vue;

      async function parsePDFContent(arrayBuffer) {
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let pnr = null;
        let cp = null;

        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          const items = textContent.items.map((item) => item.str).join(" ");

          if (!cp) {
            const matchCP = items.match(/Codice\s+CP[\s\S]*?(\d{6})/);
            if (matchCP) {
              cp = matchCP[1];
            }
          }

          if (!pnr) {
            const matchPNR = items.match(/PNR:\s*([A-Z0-9]{6})/);
            if (matchPNR) {
              pnr = matchPNR[1];
            }
          }

          if (cp && pnr) break;
        }

        return { cp, pnr };
      }

      const app = createApp({
        setup() {
          const vueServerData = ref(window.vueServerData || {});
          const browserLanguage = navigator.language || navigator.userLanguage;
          const language = ref(browserLanguage.startsWith("it") ? "IT" : "EN");

          const translations = {
            EN: {
              title: "Verify your Frecce",
              welcome:
                "Welcome! This SPA lets you extract info and search for tickets from",
              trenitaliaLink: "Trenitalia",
              trenitaliaUrl:
                "https://www.trenitalia.com/it/informazioni/cerca_e_modificailbiglietto.html",
              tickets: "Tickets",
              clearAll: "Clear all",
              verify: "Verify",
              exportReport: "Export Report",
              newVerification: "New Verification",
              emptyList: "The list is empty.",
              failedRequest: "Failed request",
              successRequest: "Success request",
              verifySuccess: "Verification executed",
              hideRequest: "Hide request",
              showRequest: "Show request",
              dropZoneText: "Drag your PDF file here",
              "label.travel.not.found": "Travel not found",
              internalServerError: "Internal Server Error",
            },
            IT: {
              title: "Verifica le tue Frecce",
              welcome:
                "Benvenuto! Questa SPA ti permette di ricavare informazioni e cercare i biglietti di",
              trenitaliaLink: "Trenitalia",
              trenitaliaUrl:
                "https://www.trenitalia.com/it/informazioni/cerca_e_modificailbiglietto.html",
              tickets: "Biglietti",
              clearAll: "Rimuovi tutti",
              verify: "Verifica",
              exportReport: "Esporta Report",
              newVerification: "Esegui una nuova verifica",
              emptyList: "La lista è vuota.",
              failedRequest: "Richiesta fallita",
              successRequest: "Richiesta riuscita",
              verifySuccess: "Verifica eseguita",
              hideRequest: "Nascondi richiesta",
              showRequest: "Mostra richiesta",
              dropZoneText: "Trascina qui il tuo file PDF",
              "label.travel.not.found": "Viaggio non trovato",
              internalServerError: "Errore interno del server",
            },
          };

          const t = (key) => {
            return translations[language.value][key] || key;
          };

          const setLanguage = (lang) => {
            language.value = lang;
          };

          const toasts = ref([]);
          const droppedFiles = ref([]);
          const fileInput = ref(null);
          const filesContainer = ref(null);
          const dragging = ref(false);

          const addToast = (message, type = "error", ms = 3000) => {
            const id = Date.now() + Math.random();
            toasts.value.push({ id, message, type });
            setTimeout(() => {
              removeToast(id);
            }, ms);
            return id;
          };

          const removeToast = (id) => {
            toasts.value = toasts.value.filter((t) => t.id !== id);
          };

          const handleDrop = async (event) => {
            const files = event.dataTransfer.files;
            for (let i = 0; i < files.length; i++) {
              const file = files[i];
              if (file.type === "application/pdf") {
                if (droppedFiles.value.some((f) => f.file.name === file.name)) {
                  addToast(
                    `Il file ${file.name} è già stato caricato.`,
                    "error"
                  );
                } else {
                  const fileObject = reactive({
                    file: file,
                    cp: null,
                    pnr: null,
                    verify: null,
                    expanded: false,
                  });
                  droppedFiles.value.push(fileObject);
                  await handlePDFParse(fileObject);
                }
              } else {
                addToast("Si accettano solo file PDF.", "warning");
              }
            }
            dragging.value = false;
          };

          const removeFiles = (file) => {
            if (file) {
              droppedFiles.value = droppedFiles.value.filter((f) => f !== file);
            } else {
              droppedFiles.value = [];
            }
          };

          const openFileDialog = () => {
            fileInput.value.click();
          };

          const handleFileSelect = async (event) => {
            const files = event.target.files;
            for (let i = 0; i < files.length; i++) {
              const file = files[i];
              if (file.type === "application/pdf") {
                if (droppedFiles.value.some((f) => f.file.name === file.name)) {
                  addToast(
                    `Il file ${file.name} è già stato caricato.`,
                    "error"
                  );
                } else {
                  const fileObject = reactive({
                    file: file,
                    cp: null,
                    pnr: null,
                    verify: null,
                    expanded: false,
                  });
                  droppedFiles.value.push(fileObject);
                  await handlePDFParse(fileObject);
                }
              } else {
                addToast("Si accettano solo file PDF.", "warning");
              }
            }
            event.target.value = "";
          };

          const handlePDFParse = async (fileObject) => {
            try {
              const arrayBuffer = await fileObject.file.arrayBuffer();
              const delay = (ms = 250) =>
                new Promise((resolve) => setTimeout(resolve, ms));

              const [result] = await Promise.all([
                parsePDFContent(arrayBuffer),
                delay(),
              ]);

              const { cp, pnr } = result;
              if (cp && pnr) {
                fileObject.cp = cp;
                fileObject.pnr = pnr;
              } else {
                addToast(
                  `Non è stato possibile estrarre PNR e CP dal file ${fileObject.file.name}`,
                  "warning"
                );
              }
            } catch (error) {
              console.error("Error processing PDF:", error);
              addToast(
                `Errore nell'elaborazione del PDF: ${error.message}`,
                "error"
              );
            }
          };

          const verifying = ref(false);
          const processedCount = ref(0);
          const successCount = ref(0);
          const failureCount = ref(0);

          const globalProgress = computed(() =>
            droppedFiles.value.length
              ? Math.round(
                  (processedCount.value / droppedFiles.value.length) * 100
                )
              : 0
          );

          const hasResults = computed(() =>
            droppedFiles.value.some((fileObject) => fileObject.verify)
          );

          const verify = async () => {
            if (verifying.value) return;
            verifying.value = true;
            processedCount.value = 0;
            successCount.value = 0;
            failureCount.value = 0;
            droppedFiles.value.forEach((fileObject) => {
              fileObject.verify = null;
              fileObject.expanded = false;
            });
            if (filesContainer.value) {
              filesContainer.value.scrollTop = 0;
            }

            const delay = (ms = 250) =>
              new Promise((resolve) => setTimeout(resolve, ms));

            for (const fileObject of droppedFiles.value) {
              fileObject.pending = true;
              const payload = {
                recoverType: "PNR_CP",
                pnr: fileObject.pnr,
                cpCode: fileObject.cp,
              };
              try {
                const path = vueServerData.value?.env
                  ? "/api/frecce/travel/recover"
                  : "https://www.lipari.dev/api/frecce/travel/recover";
                const response = await fetch(path, {
                  method: "POST",
                  headers: {
                    Accept: "application/json, application/pdf, text/calendar",
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(payload),
                });
                if (!response.ok) {
                  const result = await response.json();
                  fileObject.verify = { status: response.status, result };
                  failureCount.value++;
                  addToast(
                    `${t("failedRequest")} - ${fileObject.pnr}-${
                      fileObject.cp
                    }: ${response.statusText} - [${response.status}]`,
                    "error"
                  );
                } else {
                  const result = await response.json();
                  addToast(
                    `${t("verifySuccess")} - PNR:${fileObject.pnr} CP:${
                      fileObject.cp
                    } - [${response.status}]`,
                    "success"
                  );
                  fileObject.verify = { status: response.status, result };
                  successCount.value++;
                }
              } catch (err) {
                fileObject.verify = { error: err.message };
                failureCount.value++;
                addToast(
                  `${t("failedRequest")} per ${fileObject.pnr}-${
                    fileObject.cp
                  }: ${err.message}`,
                  "error"
                );
              } finally {
                processedCount.value++;
                fileObject.pending = false;
                await nextTick(() => {
                  if (filesContainer.value) {
                    filesContainer.value.scrollTop =
                      filesContainer.value.scrollHeight;
                  }
                });
              }
            }
            await delay(500);
            addToast(
              `Summary: ${successCount.value} success, ${failureCount.value} failure`,
              "info",
              6000
            );
            verifying.value = false;
          };

          const toggleExpand = (fileObject) => {
            if (fileObject.expanded) {
              fileObject.expanded = false;
            } else {
              droppedFiles.value.forEach((f) => (f.expanded = false));
              fileObject.expanded = true;
            }
          };

          const generatePDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const formatDate = (date) => {
              const pad = (n) => (n < 10 ? "0" + n : n);
              return `${pad(date.getDate())}-${pad(
                date.getMonth() + 1
              )}-${date.getFullYear()} ${pad(date.getHours())}:${pad(
                date.getMinutes()
              )}:${pad(date.getSeconds())}`;
            };
            const tableRows = [];
            droppedFiles.value.forEach((fileObject) => {
              if (fileObject.verify) {
                let row = {
                  pnr: fileObject.pnr || "N/A",
                  cp: fileObject.cp || "N/A",
                  status: String(fileObject.verify.status),
                  pdf: "",
                };
                if (
                  fileObject.verify.status === 200 &&
                  fileObject.verify.result?.solutions[0]?.resourceId
                ) {
                  row.pdf = "PDF";
                  row.link = `https://www.lefrecce.it/Channels.Website.BFF.WEB/website/post/purchase/pdf?resourceId=${fileObject.verify.result.solutions[0].resourceId}`;
                }
                tableRows.push(row);
              }
            });
            const tableColumns = [
              { header: "PNR", dataKey: "pnr" },
              { header: "CP", dataKey: "cp" },
              { header: "Status", dataKey: "status" },
              { header: "PDF", dataKey: "pdf" },
            ];
            // Header text (summary)
            doc.text(
              `Summary: ${successCount.value} success, ${failureCount.value} failure`,
              14,
              15
            );
            doc.autoTable({
              columns: tableColumns,
              body: tableRows,
              startY: 25,
              headStyles: {
                fillColor: [0, 0, 255],
                textColor: [255, 255, 255],
                halign: "left",
              },
              columnStyles: {
                0: { cellWidth: "wrap" },
                1: { cellWidth: "wrap" },
                2: { cellWidth: "wrap" },
                3: { cellWidth: "wrap", halign: "left" },
              },
              didParseCell: function (data) {
                if (data.section === "body") {
                  if (data.column.index === 2) {
                    data.cell.styles.textColor =
                      data.cell.text[0] === "200" ? [0, 128, 0] : [255, 0, 0];
                  }
                  if (data.column.index === 3 && data.cell.text[0] === "PDF") {
                    data.cell.styles.textColor = [0, 0, 255];
                  }
                }
              },
              didDrawCell: function (data) {
                if (
                  data.section === "body" &&
                  data.column.index === 3 &&
                  data.cell.raw === "PDF"
                ) {
                  const rowIndex = data.row.index;
                  const link = tableRows[rowIndex].link;
                  if (link) {
                    doc.link(
                      data.cell.x,
                      data.cell.y,
                      data.cell.width,
                      data.cell.height,
                      { url: link }
                    );
                  }
                }
              },
            });
            const finalY = doc.lastAutoTable.finalY
              ? doc.lastAutoTable.finalY + 10
              : 40;
            const exportInfo = `Export performed on: ${formatDate(
              new Date()
            )} from: www.lipari.dev/frecce/`;
            doc.setFontSize(10);
            doc.text(exportInfo, 14, finalY);
            doc.save("report.pdf");
          };

          return {
            language,
            t,
            setLanguage,
            dragging,
            droppedFiles,
            toasts,
            removeToast,
            handleDrop,
            removeFiles,
            openFileDialog,
            handleFileSelect,
            fileInput,
            toggleExpand,
            vueServerData,
            verifying,
            globalProgress,
            filesContainer,
            generatePDF,
            hasResults,
            verify,
            addToast,
          };
        },
      });

      // Mount the app
      app.mount("#app");
    </script>
  </body>
</html>
